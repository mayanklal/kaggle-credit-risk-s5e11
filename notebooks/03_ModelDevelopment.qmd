---
title: "Credit Risk Scorecard Model - Model Development"
author: "Mayank Lal"
date: today
format: 
    html:
        code-fold: true
        code-summary: "Code"
        code-overflow: wrap
execute:
  echo: false
  include: false
  warning: false
---
```{r setup}
## Exploratory Data Analysis
library(tidyverse) # Data Manipulation and Visualizaton
library(data.table) # Large datasets
library(vtable) # Formatted Summary Table
library(corrplot) # Correlation
library(patchwork) # Grid of plots
library(scales) # For Percentage Labels
library(rpart) # Simple Decision Tree for interaction analysis
library(rpart.plot) # Plotting Decision Trees

## Variable Selection and Feature Engineering
library(scorecard) # Information Value
library(pROC) # Gini
library(gt) # Formattting Table for publishing
library(knitr) # For simple formatting
library(DT) # For interactive tables
library(stringr) # Selecting sub-strings
library(Hmisc) # Variabel Clustering
library(car) # VIF
library(glmnet) # LASSO

# Model Development
library(MASS) # Stepwise Regression
library(lmtest)
```

This is a rough sketch notebook. We will furnish it before publishing.

```{r data}
# Load Model Data
load(file = "/workspace/Projects/kaggle-credit-risk-s5e11/data/processed/train_final_lr.Rdata")

# Load Test Data
load(file = "/workspace/Projects/kaggle-credit-risk-s5e11/data/processed/test_final_lr.Rdata")
```

## Model Development

Let's start with model development. First, we will use stepwise logistic regression to select final list of variables that improves AIC.

### Logistic Regression - Stepwise Regression (Iteration 0)

```{r lr_step}
# Create list of variables
vars <- c("working_flag_woe",
          "debt_to_income_ratio_woe",
          "credit_score_woe",
          "interest_rate_woe",
          "education_level_woe",
          "loan_purpose_woe",
          "annual_income_woe")

# Full model formula
full_formula <- as.formula(
  paste("loan_paid_back ~", paste(vars, collapse = " + "))
)

# Null model (only intercept)
null_formula <- loan_paid_back ~ 1

stepwise_model <- stepAIC(
    glm(loan_paid_back ~ ., data = train_final_lr, family = binomial),
    scope=list(lower=null_formula, upper=full_formula),
    direction="both",
    trace=TRUE
)

summary(stepwise_model)
```

### Logistic Regression - Final Model (Iteration 1)

```{r lr_final}
# Create list of final variables after stepwise regression
final_model_vars <- names(coef(stepwise_model))[-1]

# Final model formula
final_formula <- as.formula(
  paste("loan_paid_back ~", paste(final_model_vars, collapse = " + "))
)

# Build Final Logistic Regression Model
final_model <- glm(final_formula, data = train_final_lr, family = binomial)
summary(final_model)
```


#### Perform wald test for individual predictors

```{r wald_indv}
Anova(final_model)
```

### Logistic Regression - Final Model with interactions (Iteration 2)
```{r lr_interaction}
# Create interaction terms
interaction_terms <- c("debt_to_income_ratio_woe:credit_score_woe", "credit_score_woe:interest_rate_woe")

# Create final formula with interactions
final_formula_interaction <- as.formula(
  paste("loan_paid_back ~",
        paste(final_model_vars, collapse = " + "),
        "+",
        paste(interaction_terms, collapse = " + "))
)

# Build final model with interactions
final_model_interaction <- glm(final_formula_interaction,
                               data=train_final_lr,
                               family=binomial)
summary(final_model_interaction)
```

#### Perform wald joint test

```{r wald_joint}
waldtest(final_model, final_model_interaction)
```
