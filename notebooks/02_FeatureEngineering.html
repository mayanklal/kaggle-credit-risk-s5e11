<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.25">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Mayank Lal">
<meta name="dcterms.date" content="2025-11-19">

<title>Credit Risk Scorecard Model - Feature Engineering</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="02_FeatureEngineering_files/libs/clipboard/clipboard.min.js"></script>
<script src="02_FeatureEngineering_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="02_FeatureEngineering_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="02_FeatureEngineering_files/libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="02_FeatureEngineering_files/libs/quarto-html/popper.min.js"></script>
<script src="02_FeatureEngineering_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="02_FeatureEngineering_files/libs/quarto-html/anchor.min.js"></script>
<link href="02_FeatureEngineering_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="02_FeatureEngineering_files/libs/quarto-html/quarto-syntax-highlighting-7b89279ff1a6dce999919e0e67d4d9ec.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="02_FeatureEngineering_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="02_FeatureEngineering_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="02_FeatureEngineering_files/libs/bootstrap/bootstrap-b58ec4c17b101be5dd00f3f7fbc7c95b.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Credit Risk Scorecard Model - Feature Engineering</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Mayank Lal </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">November 19, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="variable-selection" class="level2">
<h2 class="anchored" data-anchor-id="variable-selection">Variable Selection</h2>
<p>We begin this journey by selecting variables for model development using regression and tree-based techniques.</p>
<p>First, we will look at Information Value.</p>
<section id="information-value" class="level3">
<h3 class="anchored" data-anchor-id="information-value">Information Value</h3>
<p>In this section, we will calculate Information Value to filter variables for regression / scorecard modeling. <to be="" elaborated="" further=""></to></p>
<div class="cell">
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>Information Value of Variables</caption>
<thead>
<tr class="header">
<th style="text-align: left;">variable</th>
<th style="text-align: right;">info_value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">employment_status</td>
<td style="text-align: right;">2.5178449</td>
</tr>
<tr class="even">
<td style="text-align: left;">debt_to_income_ratio</td>
<td style="text-align: right;">1.0405779</td>
</tr>
<tr class="odd">
<td style="text-align: left;">loan_amount</td>
<td style="text-align: right;">0.5834913</td>
</tr>
<tr class="even">
<td style="text-align: left;">annual_income</td>
<td style="text-align: right;">0.5819700</td>
</tr>
<tr class="odd">
<td style="text-align: left;">credit_score</td>
<td style="text-align: right;">0.4602449</td>
</tr>
<tr class="even">
<td style="text-align: left;">grade_subgrade</td>
<td style="text-align: right;">0.3518534</td>
</tr>
<tr class="odd">
<td style="text-align: left;">interest_rate</td>
<td style="text-align: right;">0.1615389</td>
</tr>
<tr class="even">
<td style="text-align: left;">loan_purpose</td>
<td style="text-align: right;">0.0041325</td>
</tr>
<tr class="odd">
<td style="text-align: left;">education_level</td>
<td style="text-align: right;">0.0040612</td>
</tr>
<tr class="even">
<td style="text-align: left;">gender</td>
<td style="text-align: right;">0.0003436</td>
</tr>
<tr class="odd">
<td style="text-align: left;">marital_status</td>
<td style="text-align: right;">0.0000426</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>If this wasn’t a kaggle competition with a synthetic dataset, we would have only selected variables with IV &gt; 0.02. This would have given us following variables:</p>
<ul>
<li>Employment Status</li>
<li>DTI</li>
<li>Loan Amount</li>
<li>Annual Income</li>
<li>Credit Score</li>
<li>Grade Sub-grade</li>
<li>Interest Rate</li>
</ul>
<p>But since it is a kaggle competition, we would not be enforcing such a hard criterion for filtering variables. We will combine IV with our business intuition to select following variables:</p>
<ul>
<li>Employment Status</li>
<li>DTI</li>
<li>Loan Amount</li>
<li>Annual Income</li>
<li>Credit Score</li>
<li>Grade Sub-grade</li>
<li>Interest Rate</li>
<li><strong>Loan Purpose</strong></li>
<li><strong>Education Level</strong></li>
</ul>
<p>Why have we added <strong>Loan Purpose</strong> and <strong>Education Level</strong>? We have added them back based on our EDA analysis in which we saw a clear and noticeable difference in loan repayment rate between different classes of these variables. Also, they make business intuitive sense as well.</p>
<p><strong>Loan Purpose</strong> will help us understand if a loan taken for a given purpose has higher likelihood of repayment or not. <strong>Education Level</strong> can be an indicator of future employability and income of the customer reducing the likelihood of loan default. Also, there might be an interaction between annual income and education level. We will investigate this in later phase.</p>
<p>Also, one thing to note here is that IV of Employment Status and DTI is very suspiciously high (&gt;0.5). An IV this high is rare in real-world credit datasets. It signals:</p>
<ul>
<li>Possibility of data leakage</li>
<li>Variable may be directly encoding the target</li>
<li>Or near-direct proxy for “good/bad”</li>
</ul>
<p>But since this is a synthetic dataset on Kaggle, it can be expected. For sanctity sake, we will also perform data leakage check later on.</p>
</section>
<section id="clustering-based-filtering" class="level3">
<h3 class="anchored" data-anchor-id="clustering-based-filtering">Clustering-based Filtering</h3>
<p>In this section, we will perform process to filter variables using <strong>Hierarchical Clustering</strong>.</p>
<p>Before performing clustering, we will have to transform categorical variables to numerical variables. After IV-based filtering, there are four categorical variables: <strong>Employment Status</strong>, <strong>Grade Sub-grade</strong>, <strong>Education Level</strong> and <strong>Loan Purpose</strong></p>
<p>First let’s transform <strong>Employment Status</strong>. As we have seen in our EDA, the loan repayment rate is very high for three classes - <strong>Retired, Employed and Self-employed</strong>. Similarly, it is ver low for remaining two classes - <strong>Student and Unemployed</strong>. Given the clear separation, we can merge them into two groups and then apply <strong>WOE encoding</strong> to ensure that we don’t lose any information.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>✔ Binning on 593994 rows and 2 columns in 00:00:00</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>$working_flag</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02_FeatureEngineering_files/figure-html/employment_status-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Now, we will transform <strong>Grade Sub-grade</strong> variable. As we have seen in our EDA analysis, they have monotonic relationship with loan repayment rate. Also, it is an ordinal variable with clear order: <strong>A&gt;B&gt;C&gt;D&gt;E&gt;F</strong>. Therefore, we will try to merge the sub-grades into one grade and then convert into an ordinal factor variable. Then finally into a numeric variable.</p>
<p>After that during feature engineering phase, we will try to find which transformation or encoding will be suitable for it - <strong>WOE Encoding</strong> or <strong>Target Encoding</strong>.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02_FeatureEngineering_files/figure-html/grade-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>As we can see from above chart, the Sub-grades have been merged to their Grade and converted to numeric.</p>
<p>Next we will transform both <strong>Education Level</strong> and <strong>Loan Purpose</strong>. Both of these variables have multiple classes and don’t have definite order. There is slight variation in loan repayment rate of each class of these variables. Like previously we have done with <strong>Employment Status</strong>, we would be applying <strong>WOE encoding</strong> to convert them to numeric while preserving the signal embedded in them.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>✔ Binning on 593994 rows and 3 columns in 00:00:02</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>$education_level</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02_FeatureEngineering_files/figure-html/education_loan_purpose-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
$loan_purpose</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02_FeatureEngineering_files/figure-html/education_loan_purpose-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>From the above charts, we can see that we are able to maintain monotonic relationship through <strong>WOE Encoding</strong>. It automatically merges classes within a variable to attain that. This will be used while performing modeling using logistic regression as well. Now, we will perform <strong>Hierarchical Clustering</strong>.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>✔ Binning on 593994 rows and 4 columns in 00:00:02</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>✔ Woe transformating on 593994 rows and 3 columns in 00:00:03</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>✔ Woe transformating on 254569 rows and 3 columns in 00:00:01</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02_FeatureEngineering_files/figure-html/hc-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>From the above dendogram plot, we can see that there are <strong>two key clutsters</strong> as shown below:</p>
<ul>
<li><strong>Credit Score</strong>, <strong>Grade</strong>, and <strong>Interest Rate</strong></li>
<li><strong>Debt to Income Ratio</strong> and <strong>Working Flag</strong></li>
</ul>
<p>From each of these clusters, we can select one variable with highest IV value. But before doing that we can also check their correlation and our business intuition. Based on both of them, we will decide which variables need to be kept for further processing and feature engineering.</p>
<p>We will recalculate Information Value (IV) to determine if we need to make a decision about filtering out any variables from each of the above clusters.</p>
<div class="cell">
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">variable</th>
<th style="text-align: right;">cluster</th>
<th style="text-align: right;">info_value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">annual_income</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.5819700</td>
</tr>
<tr class="even">
<td style="text-align: left;">debt_to_income_ratio</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">1.0405779</td>
</tr>
<tr class="odd">
<td style="text-align: left;">credit_score</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">0.4602449</td>
</tr>
<tr class="even">
<td style="text-align: left;">grade</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">0.3471607</td>
</tr>
<tr class="odd">
<td style="text-align: left;">interest_rate</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">0.1615389</td>
</tr>
<tr class="even">
<td style="text-align: left;">loan_amount</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">0.5834913</td>
</tr>
<tr class="odd">
<td style="text-align: left;">education_level_woe</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">0.0037469</td>
</tr>
<tr class="even">
<td style="text-align: left;">loan_purpose_woe</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">0.0039990</td>
</tr>
<tr class="odd">
<td style="text-align: left;">working_flag_woe</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">2.3126953</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Based on above table, we will keep all the variables for now. Though we should keep in mind that we can eliminate two variables from Cluster 3 if required later on.</p>
</section>
</section>
<section id="multicollinearity" class="level2">
<h2 class="anchored" data-anchor-id="multicollinearity">Multicollinearity</h2>
<p>In this section, we will perform filtering using <strong>Variance Inflation Factor (VIF)</strong> statistic. VIF measures how much the variance of a regression coefficient is inflated due to multicollinearity between predictors.</p>
<p>If a variable is strongly correlated with other predictors, its coefficient becomes unstable and its standard error becomes larger. VIF quantifies this effect. <add mathematical="" formula="" as="" well=""></add></p>
<div class="cell">
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">variable</th>
<th style="text-align: right;">vif</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">credit_score</td>
<td style="text-align: right;">9.545585</td>
</tr>
<tr class="even">
<td style="text-align: left;">grade</td>
<td style="text-align: right;">9.116141</td>
</tr>
<tr class="odd">
<td style="text-align: left;">interest_rate</td>
<td style="text-align: right;">1.408228</td>
</tr>
<tr class="even">
<td style="text-align: left;">working_flag_woe</td>
<td style="text-align: right;">1.040375</td>
</tr>
<tr class="odd">
<td style="text-align: left;">debt_to_income_ratio</td>
<td style="text-align: right;">1.033953</td>
</tr>
<tr class="even">
<td style="text-align: left;">loan_purpose_woe</td>
<td style="text-align: right;">1.000587</td>
</tr>
<tr class="odd">
<td style="text-align: left;">education_level_woe</td>
<td style="text-align: right;">1.000533</td>
</tr>
<tr class="even">
<td style="text-align: left;">loan_amount</td>
<td style="text-align: right;">1.000224</td>
</tr>
<tr class="odd">
<td style="text-align: left;">annual_income</td>
<td style="text-align: right;">1.000106</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Based on above table, we can finally make the decision to drop <strong>Grade</strong> due to multicollinearity (VIF &gt; 5) with <strong>Credit Score</strong> and <strong>Interest Rate</strong>. Also, Grade can be considered as discretized version of credit score which adds no information to our model. Therefore, we will be dropping <strong>Grade</strong> from our model.</p>
<p>Let’s recalculate VIF after dropping <strong>Grade</strong>.</p>
<div class="cell">
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">variable</th>
<th style="text-align: right;">vif</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">credit_score</td>
<td style="text-align: right;">1.420289</td>
</tr>
<tr class="even">
<td style="text-align: left;">interest_rate</td>
<td style="text-align: right;">1.408224</td>
</tr>
<tr class="odd">
<td style="text-align: left;">working_flag_woe</td>
<td style="text-align: right;">1.040292</td>
</tr>
<tr class="even">
<td style="text-align: left;">debt_to_income_ratio</td>
<td style="text-align: right;">1.033945</td>
</tr>
<tr class="odd">
<td style="text-align: left;">loan_purpose_woe</td>
<td style="text-align: right;">1.000584</td>
</tr>
<tr class="even">
<td style="text-align: left;">education_level_woe</td>
<td style="text-align: right;">1.000533</td>
</tr>
<tr class="odd">
<td style="text-align: left;">loan_amount</td>
<td style="text-align: right;">1.000222</td>
</tr>
<tr class="even">
<td style="text-align: left;">annual_income</td>
<td style="text-align: right;">1.000103</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>As we can see from above table, now VIF for all variables is under 2.</p>
</section>
<section id="data-leakage-check" class="level2">
<h2 class="anchored" data-anchor-id="data-leakage-check">Data Leakage Check</h2>
<p>In this section, we will perform three tests to confirm if there is any data leakage with regards to two variables - <strong>Working Flag</strong> and <strong>Debt to Income Ratio</strong>.</p>
<p>In first test, we will compare IV using two versions of the variable. If IV collapses drastically under a noisy or lagged version, the original variable leaks.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>$original
               variable info_value
                 &lt;char&gt;      &lt;num&gt;
1: debt_to_income_ratio   1.040578

$noisy
   variable    info_value
     &lt;char&gt;         &lt;num&gt;
1:    noisy 0.00006611242</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>$original
           variable info_value
             &lt;char&gt;      &lt;num&gt;
1: working_flag_woe   2.312695

$noisy
   variable    info_value
     &lt;char&gt;         &lt;num&gt;
1:    noisy 0.00009213036</code></pre>
</div>
</div>
<p>From IV test, it looks like there is a data leakage issue for both variables.</p>
<p>Let’s move to second test using correlation.</p>
<p>In this test, only <strong>Working Flag</strong> failed it as its correlation was greater than 0.5.</p>
<p>In the final test, we will plot WoE bins.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>✔ Binning on 593994 rows and 2 columns in 00:00:01</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>$debt_to_income_ratio</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02_FeatureEngineering_files/figure-html/woe_test-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>✔ Binning on 593994 rows and 2 columns in 00:00:00</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>$working_flag_woe</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02_FeatureEngineering_files/figure-html/woe_test-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>In this test also, <strong>Working Flag</strong> failed the test as it has a perfect monotonic curve shape.</p>
<p>Given that this is a synthetic dataset on Kaggle, we will be keeping both these variables in our dataset as they have very strong predictive power.</p>
</section>
<section id="lasso" class="level2">
<h2 class="anchored" data-anchor-id="lasso">LASSO</h2>
<p>LASSO (Least Absolute Shrinkage and Selection Operator) is a regularized version of logistic or linear regression that performs:</p>
<ul>
<li>Variable Selection</li>
<li>Coefficient Shrinkage</li>
<li>Model Simplification</li>
<li>Prevention of Overfitting</li>
</ul>
<p>It is widely used in credit-risk modeling to identify the strongest predictors before performing logistic regression.</p>
<p>Let’s LASSO.</p>
<div class="cell">
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">variable</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">annual_income</td>
</tr>
<tr class="even">
<td style="text-align: left;">debt_to_income_ratio</td>
</tr>
<tr class="odd">
<td style="text-align: left;">credit_score</td>
</tr>
<tr class="even">
<td style="text-align: left;">interest_rate</td>
</tr>
<tr class="odd">
<td style="text-align: left;">education_level_woe</td>
</tr>
<tr class="even">
<td style="text-align: left;">loan_purpose_woe</td>
</tr>
<tr class="odd">
<td style="text-align: left;">working_flag_woe</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>After performing variable selection using LASSO, only variable to be dropped is <strong>Loan Amount</strong>. It makes business intuitive sense as well because it is a representation of lender’s decision and not borrower’s quality.</p>
</section>
<section id="feature-engineering" class="level2">
<h2 class="anchored" data-anchor-id="feature-engineering">Feature Engineering</h2>
<p>In this section, we will transform final set of variables to make them suitable for Logistic Regression.</p>
<p>First, we will perform of WOE Binning of numeric variables - <strong>DTI</strong>, <strong>Annual Income</strong>, <strong>Interest Rate</strong> and <strong>Credit Score</strong>.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>✔ Binning on 593994 rows and 5 columns in 00:00:03</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>$debt_to_income_ratio</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02_FeatureEngineering_files/figure-html/woe-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
$credit_score</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02_FeatureEngineering_files/figure-html/woe-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
$annual_income</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02_FeatureEngineering_files/figure-html/woe-3.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
$interest_rate</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="02_FeatureEngineering_files/figure-html/woe-4.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>As seen from above plot, we can see that the positive probability has monotonic relationship with all WoE bins of numeric variables. This will be our final transformed variables that we will use for building logistic regression model.</p>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>