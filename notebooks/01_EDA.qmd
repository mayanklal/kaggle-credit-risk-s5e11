---
title: "Credit Risk Scorecard Model - EDA"
author: "Mayank Lal"
date: today
format: 
    html:
        code-fold: true
        code-summary: "Code"
        code-overflow: wrap
execute:
  echo: false
  include: false
  warning: false
---

```{r setup}
library(tidyverse) # Data Manipulation and Visualizaton
library(data.table) # Large datasets
library(vtable) # Formatted Summary Table
library(corrplot) # Correlation
library(patchwork) # Grid of plots
library(scales) # For Percentage Labels
library(rpart) # Simple Decision Tree for interaction analysis
library(rpart.plot) # Plotting Decision Trees
```
```{r data}
train <- fread("/workspace/Projects/kaggle-credit-risk-s5e11/data/raw/train.csv")
test <- fread("/workspace/Projects/kaggle-credit-risk-s5e11/data/raw/test.csv")
```

```{r structure}
# Check the structure
str(train)
```

## Overview

There are **593994** observations (unique accounts) with **thirteen** features:

  * ID
  * Annual Income
  * Debt to Income Ratio
  * Credit Score
  * Loan Amount
  * Interest Rate
  * Gender
  * Martial Status
  * Education Level
  * Employment Status
  * Loan Purpose
  * Grade Sub-grade
  * Loan Paid Back (Target Variable)
  
## Data Summary
```{r var_types}
train_num <- train %>% select(where(is.numeric))
train_char <- train %>% select(where(is.character))
```

We will look at the summary statistics of all variables. First, let's have a look at the summary statistics of **numeric variables** in the dataset.

```{r preprocess}
# Check for duplicate rows in the dataset
train_duplicates <- train %>%
                      add_count(id) %>%
                      filter(n>1) %>%
                      distinct() 
# There are no duplicates in the dataset.
```

```{r summary_numeric, include = TRUE}
st(train_num, 
   summ = list(
     c('notNA(x)','countNA(x)','mean(x)','sd(x)','min(x)','max(x)')
   ),
   summ.names = list(
     c('N','Missing','Mean','Std. Dev.','Min','Max')
   ),
   title = "Summary Statistics of Numeric Variables")
```


As seen from the above table, there are five numeric features - Annual Income, Debt to Income Ratio, Credit Score, Loan Amount and Interest Rate - that can be seen as predictor variables. Out of these five predictor variables, three variables - _DTI, Credit Score and Interest Rate_ - can be further binned to represent different bands. While we need to look at correlation between DTI, Annual Income and Loan Amount, we also can derive another feature by taking ratio of Loan Amount to Annual Income.

In addtion to these variables, there is one unique identifier variable, ID, that represents unique customers and can be used to remove duplicates from the dataset.

Finally, there is target variable - Loan Paid Back -  which we are going to model in our classification models.

Let's have a look at summary statistics of **factor variables**.
```{r summary_cat, include = TRUE}
# Convert all character variables to factors
char_vars <- colnames(train_char)
train_char <- train_char %>% mutate_if(is.character, as.factor)
st(train_char,
   title = "Summary Statistics of Character Variables")
```

As seen from above table, there are six character variables - _Gender, Marital Status, Education Level, Employment Status, Loan Purpose and Grade Sub-grade_.

Loan Purpose and Grade Sub-grade has more than five levels and needs to be rationalized to lower number of categories. 

## Univariate Analysis

In Univariate Analysis, we look at the distribution of predictor variables - both numeric and character.

### Distribution of Target Variable

Loan Paid Back (**loan_paid_back**) is the target variable for our classification models. This means that our objective is to predict the probability of a customer to pay back his/her/their loan. Let's have a look at its distribution.

```{r target_variable_train, include = TRUE}
#| fig.width: 12
#| fig.height: 8
#| fig.align: "center"
train <- train %>%
    mutate(loan_paid_back = factor(loan_paid_back, levels = c(1, 0)))
train %>% ggplot(aes(x = loan_paid_back)) +
    geom_bar() +
    labs(
        title = "Distribution of Target Variable - Loan Paid Back",
        x = "Loan Paid Back",
        y = "Count"
        ) +
    scale_fill_grey() +
    theme_bw()
```

It is right-skewed distribution. Mostly belongs to loan paid back category. As it is a skewed dataset, we need to apply undersampling or
oversampling.

### Distribution of numeric variables

There are five numeric variables in the dataset. Let's have a look
at their histogram.

```{r numeric_dist, include = TRUE}
#| fig.width: 12
#| fig.height: 8
#| fig.align: "center"
# Plot histogram of annual_income
train %>% ggplot(aes(x = annual_income)) +
    geom_histogram() +
    labs(
        title = "Histogram of Annual Income",
        x = "Annual Income",
        y = "Count"
        ) +
    scale_fill_grey() +
    theme_bw()

# Plot histogram of DTI
train %>% ggplot(aes(x = debt_to_income_ratio)) +
    geom_histogram() +
    labs(
        title = "Histogram of DTI",
        x = "DTI",
        y = "Count"
        ) +
    scale_fill_grey() +
    theme_bw()

# Plot histogram of credit_score
train %>% ggplot(aes(credit_score)) +
    geom_histogram() +
    labs(
        title = "Histogram of Credit Score",
        x = "Credit Score",
        y = "Count"
        ) +
    scale_fill_grey() +
    theme_bw()

# Plot histogram of loan_amount
train %>% ggplot(aes(loan_amount)) +
    geom_histogram() +
    labs(
        title = "Histogram of Loan Amount",
        x = "Loan Amount",
        y = "Count"
        ) +
    scale_fill_grey() +
    theme_bw()

# Plot histogram of interest
train %>% ggplot(aes(interest_rate)) +
    geom_histogram() +
    labs(
        title = "Histogram of Interest Rate",
        x = "Interest Rate",
        y = "Count"
        ) +
    scale_fill_grey() +
    theme_bw()
```

**Summary of numeric variables**:

* Annual Income is left-skewed.
* Debt to Income Ratio is left-skewed.
* Credit Score is normal distributed with skewness towards right and outliers towards left as well.
* Loan Amount is skewed towards left with a long right tail.
* Interest Rate is normally distributed.

### Distribution of categorical variables

There are six categorical variables in the dataset. Let's have a look look at their bar plot.

```{r cat_dist, include = TRUE}
#| fig.width: 12
#| fig.height: 8
#| fig.align: "center"
# Plot bar plot of gender 
train %>% ggplot(aes(gender)) +
    geom_bar() +
    labs(
        title = "Distribution of Gender",
        x = "Gender",
        y = "Count"
        ) +
    scale_fill_grey() +
    theme_bw()

# Plot bar plot of Marital Status
train %>% ggplot(aes(marital_status)) +
    geom_bar() +
    labs(
        title = "Distribution of Marital Status",
        x = "Marital Status",
        y = "Count"
        ) +
    scale_fill_grey() +
    theme_bw()

# Plot bar plot of educational level
train %>% ggplot(aes(education_level)) +
    geom_bar() +
    labs(
        title = "Distribution of Education Level",
        x = "Education Level",
        y = "Count"
        ) +
    scale_fill_grey() +
    theme_bw()

# Plot bar plot of employment_status
train %>% ggplot(aes(employment_status)) +
    geom_bar() +
    labs(
        title = "Distribution of Employment Status",
        x = "Employment Status",
        y = "Count"
        ) +
    scale_fill_grey() +
    theme_bw()

# Plot bar plot of loan purpose
train %>% ggplot(aes(loan_purpose)) +
    geom_bar() +
    labs(
        title = "Distribution of Loan Purpose",
        x = "Loan Purpose",
        y = "Count"
        ) +
    scale_fill_grey() +
    theme_bw()

# Plot bar plot of grade subgrade
train %>% ggplot(aes(grade_subgrade)) + 
    geom_bar() +
    labs(
        title = "Distribution of Grade Sub-grade",
        x = "Grade Sub-grade",
        y = "Count"
        ) +
    scale_fill_grey() +
    theme_bw()
```

**Summary of categorical variables**:

* Gender is nearly equally distributed between male and female. Few accounts are there in other as well.
* Marital Status is nearly equally distributed between married and single. Other two categories are Divorced and Widowed.
* Education Level has five levels. Majority of the accounts are in Bachelor's, High School and Masters. Two other categories are PhD and Other.
* Employment Status has five levels. Majority of the customers are employed.
* Loan Purpose is dominated by Debt consolidation. In additon, there are seven more categories which can be combined into one category.
* There are grades with subgrades as well. Grades are from A to F. Each grade has five sub-levels as well. Most of the accounts are in C and D grade. Granularity can be reduced.
* One key finding is that 55% of the loans have been taken for **Debt consolidation**. This means that they have been taken out a new loan to pay off multiple existing debts.

## Bivariate Analysis

In bivariate analysis, we will look at the relationship between predictor variables and target variable.

### Debt to Income Ratio x Loan Paid Back

**Debt to Income Ratio** is a ratio of total debt payments divided by gross income (before tax) expressed as percentage, usually on either a monthly or annual basis.

It is one of the most important feature to understand the credit risk from an applicant.

Let's have a look at its relationship with regards to the target variable.

```{r dti, include = TRUE}
#| fig.width: 12
#| fig.height: 8
#| fig.align: "center"
train %>%
    select(debt_to_income_ratio, loan_paid_back) %>%
    ggplot(aes(debt_to_income_ratio, fill = loan_paid_back)) +
    geom_density(alpha = 0.5) +
    labs(
        title = "Kernel Density Plot of DTI by Loan Paid Back",
        x = "DTI",
        y = "Density"
    ) +
    scale_fill_grey() +
    theme_bw()
```

As we can see for the chart above, the distribution of DTI is skewed more towards left when Loan Paid Back is 1. It is in line with business expectation that the accounts with higher DTI have lower probability of paying back their loan.

```{r dti_outlier, include = TRUE}
#| fig.width: 12
#| fig.height: 8
#| fig.align: "center"
train %>%
    select(debt_to_income_ratio, loan_paid_back) %>%
    ggplot(aes(debt_to_income_ratio, loan_paid_back)) +
    geom_boxplot() +
    labs(
        title = "Box Plot of DTI by Loan Paid Back",
        x = "DTI",
        y = "Loan Paid Back"
    ) +
    scale_fill_grey() +
    theme_bw()
```

From the box plot, it can be seen that the median debt-to-income ratio of the customers who have paid back their loan is lower than the customers who didn't pay back their loan.

### Credit Score x Loan Paid Back

**Credit Score** is an indicator of an individual's creditworthiness (ability to pay a loan back on time). 

It is generally provided by external credit agencies to a financial institution and is one of the key metric to evaluate credit risk of an individual/applicant.

Let's have a look at its relationship with regards to the target variable.

```{r credit_score, include = TRUE}
#| fig.width: 12
#| fig.height: 8
#| fig.align: "center"
train %>%
    select(credit_score, loan_paid_back) %>%
    ggplot(aes(credit_score, fill = loan_paid_back)) +
    geom_density(alpha = 0.5) +
    labs(
        title = "Kernel Density Plot of Interest Credit Score by Loan Paid Back",
        x = "Credit Score",
        y = "Density"
    ) +
    scale_fill_grey() +
    theme_bw()
```

As we can see for the chart above, lower credit score customers are in higher concentration in the bucket where customer didn't pay back their loans.

```{r credit_score_outlier, include = TRUE}
#| fig.width: 12
#| fig.height: 8
#| fig.align: "center"
train %>%
    select(credit_score, loan_paid_back) %>%
    ggplot(aes(credit_score, loan_paid_back)) +
    geom_boxplot() +
    labs(
        title = "Box Plot of Credit Score by Loan Paid Back",
        x = "Credit Score",
        y = "Loan Paid Back"
    ) +
    scale_fill_grey() +
    theme_bw()
```

From the box plot, it can be seen that the credit score of the customers who have paid back their loan is higher than the customers who didn't pay back their loan.

### Interest Rate x Loan Paid Back

**Interest Rate** is the amount of interest due per period, as a proportion of the amount lent, deposited, or borrowed.  

It is generally decided by the financial institution as a function of central bank's lending rate to the bank and credit worthiness of the customer/applicant.

Let's have a look at its relationship with regards to the target variable.

```{r interest_rate, include = TRUE}
#| fig.width: 12
#| fig.height: 8
#| fig.align: "center"
train %>%
    select(interest_rate, loan_paid_back) %>%
    ggplot(aes(interest_rate, fill = loan_paid_back)) +
    geom_density(alpha = 0.5) +
    labs(
        title = "Kernel Density Plot of Interest Rate by Loan Paid Back",
        x = "Interest Rate",
        y = "Density"
    ) +
    scale_fill_grey() +
    theme_bw()
```

As we can see for the chart above, the likelihood of loan repayment goes down with higher interest rate. But given the overlap between the distirbutions, it doesn't seem to have a good predictive power.

```{r interest_rate_outlier, include = TRUE}
#| fig.width: 12
#| fig.height: 8
#| fig.align: "center"
train %>%
    select(interest_rate, loan_paid_back) %>%
    ggplot(aes(interest_rate, loan_paid_back)) +
    geom_boxplot() +
    labs(
        title = "Box Plot of Interest Rate by Loan Paid Back",
        x = "Interest Rate",
        y = "Loan Paid Back"
    ) +
    scale_fill_grey() +
    theme_bw()
```

From the box plot, it can be seen that the interest rate of the customers who have paid back their loan is lower than the customers who didn't pay back their loan.

### Loan Amount x Loan Paid Back

**Loan Amount** is the amount that has been borrowed by the customer.

My priori is that this variable doesn't have enough predicitive power on its own. But with another variable like annual income, it might have better predicitive power. On the least, I expect that the accounts with higher loan amount will have higher likelihood of defaulting on loan payment.

Let's have a look at its relationship with regards to the target variable.

```{r loan_amount, include = TRUE}
#| fig.width: 12
#| fig.height: 8
#| fig.align: "center"
train %>%
    select(loan_amount, loan_paid_back) %>%
    ggplot(aes(loan_amount, fill = loan_paid_back)) +
    geom_density(alpha = 0.5) +
    labs(
        title = "Kernel Density Plot of Loan Amount by Loan Paid Back",
        x = "Loan Amount",
        y = "Density"
    ) +
    scale_fill_grey() +
    theme_bw()
```

As we can see for the chart above, the distribution of the customers who paid back their loan is very close to customers who didn't pay back their loan. As expected, it doesn't seem to have a good predictive power.

```{r loan_amount_outlier, include = TRUE}
#| fig.width: 12
#| fig.height: 8
#| fig.align: "center"
train %>%
    select(loan_amount, loan_paid_back) %>%
    ggplot(aes(loan_amount, loan_paid_back)) +
    geom_boxplot() +
    labs(
        title = "Box Plot of Loan Amount by Loan Paid Back",
        x = "Loan Amount",
        y = "Loan Paid Back"
    ) +
    scale_fill_grey() +
    theme_bw()
```

From the box plot, it can be seen that the loan amount of the customers who have paid back their loan is similar to the customers who didn't pay back their loan.

### Annual Income x Loan Paid Back

**Annual Income** is the total amount of money an individual or business earns in a year from all sources, such as salary, bonuses, investments, and other earnings, before any deductions are taken.

My priori is for this variable is same as that of Loan Amount. On the least, I expect that the accounts with higher annual income will have higher likelihood of repaying their loan.

Let's have a look at its relationship with regards to the target variable.

```{r annual_income, include = TRUE}
#| fig.width: 12
#| fig.height: 8
#| fig.align: "center"
train %>%
    select(annual_income, loan_paid_back) %>%
    ggplot(aes(annual_income, fill = loan_paid_back)) +
    geom_density(alpha = 0.5) +
    labs(
        title = "Kernel Density Plot of Annual Income by Loan Paid Back",
        x = "Annual Income",
        y = "Density"
    ) +
    scale_fill_grey() +
    theme_bw()
```

As we can see for the chart above, the distribution of the customers who paid back their loan is very similar to the customers who didn't pay back their loan. As expected, it doesn't seem to have a good predictive power.

```{r annual_income_outlier, include = TRUE}
#| fig.width: 12
#| fig.height: 8
#| fig.align: "center"
train %>%
    select(annual_income, loan_paid_back) %>%
    ggplot(aes(annual_income, loan_paid_back)) +
    geom_boxplot()+
    labs(
        title = "Box Plot of Annual Income by Loan Paid Back",
        x = "Annual Income",
        y = "Loan Paid Back"
    ) +
    scale_fill_grey() +
    theme_bw()
```

From the box plot, it can be seen that the annual income of the customers who have paid back their loan is similar to the customers who didn't pay back their loan.

### Gender x Loan Paid Back

Looking at **Gender** and its relationship with regards to the target variable can help us understand if probability of repayment of loan is better for women than men. The priori is based on research that shows women tend to exhibit more prudent financial behaviors in some areas, such as saving and long-term planning, while men tend to take more risks with investments.

Let's have a look at the chart below.

```{r gender, include = TRUE}
#| fig.width: 12
#| fig.height: 8
#| fig.align: "center"
train %>%
    select(gender, loan_paid_back) %>%
    ggplot(aes(x = gender, fill = loan_paid_back)) +
    geom_bar(position = "dodge") +
    labs(
        title = "Loan Repayment Distribution by Gender",
        x = "Gender",
        y = "Count",
        fill = "Loan Paid Back"
        ) +
    scale_fill_grey() +
    theme_bw()
```

As we can see for the chart above, there doesn't seem to be any difference in the likelihood of loan repayment due to gender.

### Marital Status x Loan Paid Back

Looking at **Marital Status** and its relationship with regards to the target variable can help us understand if probability of repayment of loan is better for customers with family. The priori is based on research that shows folks with families will be more prudent in their financial behaviors.

Let's have a look at the chart below.

```{r marital_status, include = TRUE}
#| fig.width: 12
#| fig.height: 8
#| fig.align: "center"
train %>%
    select(marital_status, loan_paid_back) %>%
    ggplot(aes(x = marital_status, fill = loan_paid_back)) +
    geom_bar(position = "dodge") +
    labs(
        title = "Loan Repayment Distribution by Marital Status",
        x = "Marital Status",
        y = "Count",
        fill = "Loan Paid Back"
        ) +
    scale_fill_grey() +
    theme_bw()
```

As we can see for the chart above, there doesn't seem to be any difference in the likelihood of loan repayment due to marital status.


### Education Level x Loan Paid Back

Looking at **Education Level** and its relationship with regards to the target variable can help us understand if probability of repayment of loan is better for customers with higher education levels. The priori is based on research that shows folks with better education levels will be more prudent in their financial behaviors.

Let's have a look at the chart below.

```{r education_level, include = TRUE}
#| fig.width: 12
#| fig.height: 8
#| fig.align: "center"
train %>%
    select(education_level, loan_paid_back) %>%
    ggplot(aes(x = education_level, fill = loan_paid_back)) +
    geom_bar(position = "dodge") +
    labs(
        title = "Loan Repayment Distribution by Education Level",
        x = "Education Level",
        y = "Count",
        fill = "Loan Paid Back"
        ) +
    scale_fill_grey() +
    theme_bw()
```

As we can see for the chart above, there doesn't seem to be any difference in the likelihood of loan repayment due to education level.

### Employment Status x Loan Paid Back

Looking at **Employment Status** and its relationship with regards to the target variable can help us understand if probability of repayment of loan is better for customers with employment. The priori is based on research that shows folks with employment will be more prudent in their financial behaviors.

Let's have a look at the chart below.


```{r employment_status, include = TRUE}
#| fig.width: 12
#| fig.height: 8
#| fig.align: "center"
train %>%
    select(employment_status, loan_paid_back) %>%
    ggplot(aes(x = employment_status, fill = loan_paid_back)) +
    geom_bar(position = "dodge") +
    labs(
        title = "Loan Repayment Distribution by Employment Status",
        x = "Employment Status",
        y = "Count",
        fill = "Loan Paid Back"
        ) +
    scale_fill_grey() +
    theme_bw()
```

As we can see for the chart above, customers who are unemployed or student are less likely to pay back their loan.

### Loan Purpose x Loan Paid Back

As the name suggests, **Loan Purpose** tells us the purpose for which the customer has taken their loan. Given what we have seen in univariate analysis, majority of customer have taken their loan to repay their earlier loans. 

Let's see if the other categories show difference between both classes of target variable.

```{r loan_purpose, include = TRUE}
#| fig.width: 12
#| fig.height: 8
#| fig.align: "center"
train %>%
    select(loan_purpose, loan_paid_back) %>%
    ggplot(aes(x = loan_purpose, fill = loan_paid_back)) +
    geom_bar(position = "dodge") +
    labs(
        title = "Loan Repayment Distribution by Loan Purpose",
        x = "Loan Purpose",
        y = "Count",
        fill = "Loan Paid Back"
        ) +
    scale_fill_grey() +
    theme_bw()
```

From the chart above, it doesn't seem that the other categories can help us distinguish between the two classes of our target variable. So, it is safe to say that we can combine other categories into one.

### Grade with Sub-grade x Loan Paid Back

Like Credit Score, Loan grades and subgrades are a classification system used by lenders to assess the credit risk of a borrower.

The priori is here that the loan grades like A denotes high quality loans. So there is high likelihood of repayment by these set of loans.

Let's see if the data validates our priori.

```{r grade_subgrade, include = TRUE}
#| fig.width: 12
#| fig.height: 8
#| fig.align: "center"
train %>%
    select(grade_subgrade, loan_paid_back) %>%
    ggplot(aes(x = grade_subgrade, fill = loan_paid_back)) +
    geom_bar(position = "dodge") +
    labs(
        title = "Loan Repayment Distribution by Grade Sub-grade",
        x = "Grade Sub-grade",
        y = "Count",
        fill = "Loan Paid Back"
        ) +
    scale_fill_grey() +
    theme_bw()
```

From the chart above, it looks that the likelihood of repayment worsens as we go from higher grade to lower grade. Also, we can reduce the number of categories here by combining subgrades into one grade.

## Monotonicity Analysis

In this section, we will perform monotonicity analysis to check whether the relationship between each predictor and the target variable follows a consistent increasing or decreasing trend. Variables with monotonic behavior are easier to model and interpret, especially in logistic regression and credit risk scorecards.

For numeric variables, the data will be binned, and the payment rate (good rate) is calculated for each bin to assess whether the trend is smooth and one directional.

Let's have a look at the monotonicity of numeric variables after quantile binning.

```{r num_bins}
train_num  <- train_num %>%
    mutate(loan_to_income_ratio = loan_amount/annual_income) %>%
    mutate(DTI_Bins = cut_number(debt_to_income_ratio, 
                                 n = 10,
                                 right = F),
          CreditScore_Bins = cut_number(credit_score, 
                                 n = 10,
                                 right = F),
          InterestRate_Bins = cut_number(interest_rate, 
                                 n = 10,
                                 right = F),
          LTI_Bins = cut_number(loan_to_income_ratio, 
                                 n = 10,
                                 right = F))
train_num_bins <- train_num %>%
                      select(id, 
                             DTI_Bins, 
                             CreditScore_Bins,
                             InterestRate_Bins,
                             LTI_Bins,
                             loan_paid_back)
```

### Bubble Plot of Debt-to-Income Ratio (DTI)

First, we will look at the relationship between DTI and Good Rate (Rate of Payment of Loan). 

```{r dti_mono, include = TRUE}
#| fig.width: 12
#| fig.height: 8
#| fig.align: "center"
plot_bubble_chart <- function(data, var, target_var, title, x_label) {
bubble <- data %>%
  group_by({{var}}) %>%
  summarise(
    good_rate = mean({{target_var}} == 1),
    count = n()
  ) %>%
  ggplot(aes(x = {{var}}, y = good_rate, size = count)) +
  geom_point(alpha = 0.5) +
  scale_size(range = c(10, 20), name = "No. of Customers") +
  labs(
        title = title,
        x = x_label,
        y = "Loan Repayment Rate"
    ) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 10))
return(bubble)
}
plot_bubble_chart(train_num_bins, DTI_Bins, loan_paid_back, "Bubble Plot of DTI by Loan Repayment Rate", "Gender")
```

As it can be seen from the above chart, the loan repayment rate decreases with increasing DTI, confirming our business intiuition that
higher debt burden corresponds to higher default risk.


### Bubble Plot of Credit Score

Now, let's look at the relationship between Credit Score and Good Rate (Rate of Payment of Loan). 

```{r credit_score_mono, include = TRUE}
#| fig.width: 12
#| fig.height: 8
#| fig.align: "center"
plot_bubble_chart(train_num_bins, CreditScore_Bins, loan_paid_back,  "Bubble Plot of Credit Score by Loan Repayment Rate", "Gender")
```

As it can be seen from the above chart, the loan repayment rate increases with increasing Credit Score, confirming our business intiuition that better credit score corresponds to lower default risk.

### Bubble Plot of Interest Rate

Next, we will look at the relationship between Interest Rate and Good Rate (Rate of Payment of Loan). 

```{r interest_rate_mono, include = TRUE}
#| fig.width: 12
#| fig.height: 8
#| fig.align: "center"
plot_bubble_chart(train_num_bins, InterestRate_Bins, loan_paid_back,  "Bubble Plot of Interest Rate by Loan Repayment Rate", "Gender")
```

As it can be seen from the above chart, the loan repayment rate decreases with increasing Interest Rate, confirming our business intiuition that increasing interest rate corresponds to higher default risk.

### Bubble Plot of Loan to Income Ratio (LTI)

Here, instead of creating separate bubble plots for loan amount and annual income, I have derived another variable using them called **Loan to Income Ratio**. As compared to DTI, LTI tells us the affordability of this specific loan. Its focus is on the capacity risk of the customer, i.e., the ability to sustain new loan. Let's have a look at the relationship between LTI and Good Rate (Rate of Payment of Loan). 

```{r lti_mono, include = TRUE}
#| fig.width: 12
#| fig.height: 8
#| fig.align: "center"
plot_bubble_chart(train_num_bins, LTI_Bins, loan_paid_back,  "Bubble Plot of LTI by Loan Repayment Rate", "Gender")
```

As it can be seen from the above chart, the loan repayment rate has a non-monotonic relationship with LTI. The repayment probability first rises and then falls.

### Bubble Plot of Gender

In this section, we will look at bubble plot of categorical variables. First, let's look at bubble plot of Gender.

```{r gender_mono, include = TRUE}
#| fig.width: 12
#| fig.height: 8
#| fig.align: "center"
plot_bubble_chart(train, gender, loan_paid_back, "Bubble Plot of Gender by Loan Repayment Rate", "Gender")
```

As we can see from the above chart, the loan repayment rate of all three categories of gender are very close to each other as we have seen previously in the bar chart as well. This further confirms it. A general order that gets revealed is: Female > Male > Other.

### Bubble Plot of Marital Status

Next, we will look at bubble plot of Marital Status.

```{r marital_status_mono, include = TRUE}
#| fig.width: 12
#| fig.height: 8
#| fig.align: "center"
plot_bubble_chart(train, marital_status, loan_paid_back, "Bubble Plot of Marital Status by Loan Repayment Rate", "Marital Status")
```

As we can see from the above chart, the loan repayment rate of all three categories of marital status are very close to each other as we have seen previously in the bar chart as well. This further confirms it. A general order that gets revealed is: Married > Single > Divorced > Widowed.

### Bubble Plot of Education Level

Now, we will look at bubble plot of Education Level.

```{r education_level_mono, include = TRUE}
#| fig.width: 12
#| fig.height: 8
#| fig.align: "center"
plot_bubble_chart(train, education_level, loan_paid_back, "Bubble Plot of Education Level by Loan Repayment Rate", "Education Level")
```

As we can see from the above chart, the loan repayment rate of all three categories of education level are very close to each other as we have seen previously in the bar chart as well. This further confirms it. A general order that gets revealed is: PhD > High School > Master's > Other > Bachelor's.

### Bubble Plot of Employment Status

Here we will look at bubble plot of Employment Status.

```{r employment_status_mono, include = TRUE}
#| fig.width: 12
#| fig.height: 8
#| fig.align: "center"
plot_bubble_chart(train, employment_status, loan_paid_back, "Bubble Plot of Employment Status by Loan Repayment Rate", "Employment Status")
```

As we can see from the above chart, the loan repayment rate of all three categories of employment status show a monotonic downward trend as we have seen previously in the bar chart as well. This further confirms it. A general order that gets revealed is: Retired > Employed > Self-employed > Student > Unemployed.

### Bubble Plot of Loan Purpose

In below chart, we will look at bubble plot of Loan Purpose.

```{r loan_purpose_mono, include = TRUE}
#| fig.width: 12
#| fig.height: 8
#| fig.align: "center"
plot_bubble_chart(train, loan_purpose, loan_paid_back, "Bubble Plot of Loan Purpose by Loan Repayment Rate", "Loan Purpose")
```

As we can see from the above chart, the loan repayment rate of all three categories of loan purpose are very close to each other as we have seen previously in the bar chart as well. This further confirms it. 

### Bubble Plot of Grade Sub-grade

Finally, let's have look at bubble plot of grade sub-grade.

```{r grade_subgrade_mono, include = TRUE}
#| fig.width: 12
#| fig.height: 8
#| fig.align: "center"
plot_bubble_chart(train, grade_subgrade, loan_paid_back, "Bubble Plot of Grade Sub-grade by Loan Repayment Rate", "Grade Sub-grade")
```

As we can see from the above chart, the loan repayment rate of all three categories of grade sub-grade show a clear monotonic downward trend as we have seen previously in the bar chart as well. This further confirms it. A general order that gets revealed is: A > B > C > D > E > F.
 

## Correlation Analysis

In this section, we will perform correlation analysis to identify variables that convery similar information, which can cause redundancy and instability in models. Since most numeric variables in this dataset are skewed and show monotonic rather than linear relationships, **Spearman's rank correlation** is used instead of Pearson's. It is more robust to outliers and better suited for non-nomral, monotoninc data common in credit risk modelling.

```{r corr, include = TRUE}
#| fig.width: 12
#| fig.height: 8
#| fig.align: "center"
train_num %>%
    select(-id, -loan_amount, -annual_income, -DTI_Bins, -CreditScore_Bins, -InterestRate_Bins, -LTI_Bins) %>%
    mutate(across(everything(), as.numeric)) %>%
    cor(method = "spearman") %>%
    corrplot(type = "upper", 
         diag = FALSE, 
         method = "color",
         addCoef.col = "black",
         tl.col = "black",
         tl.srt = 45,
         order = "hclust",
         col = gray.colors(100, start=0.9, end=0.1))
```

As seen from the above chart, it can be concluded that the numeric predictors show low to moderate correlations, with credit score and DTI displaying expected opposing trends. The weak pairwise correlations indicate low redundancy, making all variables suitable for further modeling and feature selection.

## Interaction Analysis

In this section, we will try to identify variable pairs which can have interaction between them. We will use business intuition and a simple decision tree to identify these pair of variables.

```{r tree, include = TRUE}
#| fig.width: 12
#| fig.height: 8
#| fig.align: "center"
train_main <- train %>% select(-id)
tree_model <- rpart(
    loan_paid_back ~ .,
    data = train_main,
    control = rpart.control(maxdepth = 6, minsplit = 5000, cp =  0.001)
)
rpart.plot(tree_model, type = 2, extra = 1, under = TRUE)
```

Based on the decision tree as shown above and business intuition, we have shortlisted following pairs:

- Employment Status x DTI
- DTI x Credit Score
- Interest Rate x Credit Score
- Loan Purpose x LTI
- Employment Status x Grade Sub-grade

### Line Plot of Employment Status by DTI

Let's start by looking at line plot to understand the interaction between Employment Status and DTI.

```{r es_dti_int, include = TRUE}
#| fig.width: 12
#| fig.height: 8
#| fig.align: "center"
train_bins_char <- train_num_bins %>% select(-loan_paid_back) %>%
                        left_join(train, by = join_by(id)) 
train_bins_char %>%
    group_by(employment_status, DTI_Bins) %>%
    summarise(good_rate = mean(loan_paid_back == 1)) %>%
    ggplot(aes(x = DTI_Bins, y = good_rate, group = employment_status, linetype = employment_status)) +
    geom_line(color = "black") +
    geom_point(color = "black") +
    scale_y_continuous(
    labels = label_percent(accuracy = 1),  # Converts 0.85 → 85%
    limits = c(0, 1),                      # Optional: fixes y-axis from 0–100%
    expand = expansion(mult = c(0, 0.05))) +
    labs(
            title = "Interaction b/w Employment Status and DTI",
            x = "DTI",
            y = "Loan Repayment Rate (%)"
        ) +
        theme_bw() +
        theme(legend.title = element_blank())
```

As seen from the above chart, it can be clearly seen that customers with the employment status - Employed, Retired and Self-employed have higher repayment rate across DTI Bins than the customers with the employment status - Student and Unemployed.

So, their interaction can help us identify customers with higher or lower default risk.

### Line Plot of Loan Purpose by LTI

Next, we will look at line plot to understand the interaction between Loan Purpose and LTI.

```{r ls_lti_int, include = TRUE}
#| fig.width: 12
#| fig.height: 8
#| fig.align: "center"
train_bins_char %>%
    group_by(loan_purpose, LTI_Bins) %>%
    summarise(good_rate = mean(loan_paid_back == 1)) %>%
    ggplot(aes(x = LTI_Bins, y = good_rate, group = loan_purpose, linetype = loan_purpose)) +
    geom_line(color = "black") +
    geom_point(color = "black") +
    scale_y_continuous(
    labels = label_percent(accuracy = 1),  # Converts 0.85 → 85%
    limits = c(0, 1),                      # Optional: fixes y-axis from 0–100%
    expand = expansion(mult = c(0, 0.05))) +
    labs(
            title = "Interaction b/w Loan Purpose and LTI",
            x = "LTI",
            y = "Loan Repayment Rate (%)"
        ) +
        theme_bw() +
        theme(legend.title = element_blank())
```

As seen from the above chart, there doesn't seem to be an interaction between LTI and Loan purpose as the loan repayment rate remains stable across all LTI bins and in similar range for all categories of loan purposes.

### Line Plot of Education Level by LTI

Next, we will look at line plot to understand the interaction between Education Level and LTI.

```{r el_lti_int, include = TRUE}
#| fig.width: 12
#| fig.height: 8
#| fig.align: "center"
train_bins_char %>%
    group_by(education_level, LTI_Bins) %>%
    summarise(good_rate = mean(loan_paid_back == 1)) %>%
    ggplot(aes(x = LTI_Bins, y = good_rate, group = education_level, linetype = education_level)) +
    geom_line(color = "black") +
    geom_point(color = "black") +
    scale_y_continuous(
    labels = label_percent(accuracy = 1),  # Converts 0.85 → 85%
    limits = c(0, 1),                      # Optional: fixes y-axis from 0–100%
    expand = expansion(mult = c(0, 0.05))) +
    labs(
            title = "Interaction b/w Education Level and LTI",
            x = "LTI",
            y = "Loan Repayment Rate (%)"
        ) +
        theme_bw() +
        theme(legend.title = element_blank())
```

As seen from the above chart, there doesn't seem to be an interaction between LTI and Education Level as the loan repayment rate remains stable across all LTI bins and in similar range for all categories of education levels.

### Heatmap of DTI by Credit Score

We will use heatmap to understand the interaction between DTI and Credit Score.

```{r cs_dti_int, include = TRUE}
#| fig.width: 12
#| fig.height: 8
#| fig.align: "center"
train_bins_char %>%
    group_by(DTI_Bins, CreditScore_Bins) %>%
    summarise(good_rate = mean(loan_paid_back == 1)) %>%
    ggplot(aes(x = DTI_Bins, y = CreditScore_Bins, fill = good_rate)) +
    geom_tile(color = "white") +
    scale_fill_gradient(
        low = "grey90",
        high = "black",
        name = "Loan Repayment Rate"
    ) +
    labs(
            title = "Interaction b/w DTI and Credit Score",
            x = "DTI",
            y = "Credit Score"
        ) +
        theme_bw()
```

As seen from the above chart, it can be clearly seen that the loan repayment rate goes down as the credit score falls and DTI increases.Their interaction can also help us identify customers with higher or lower default risk.

### Heatmap of Interest Rate by Credit Score

Next, we will look at heatmap to understand the interaction between Interest Rate and Credit Score.

```{r cs_ir_int, include = TRUE}
#| fig.width: 12
#| fig.height: 8
#| fig.align: "center"
train_bins_char %>%
    group_by(InterestRate_Bins, CreditScore_Bins) %>%
    summarise(good_rate = mean(loan_paid_back == 1)) %>%
    ggplot(aes(x = InterestRate_Bins, y = CreditScore_Bins, fill = good_rate)) +
    geom_tile(color = "white") +
    scale_fill_gradient(
        low = "grey90",
        high = "black",
        name = "Loan Repayment Rate"
    ) +
    labs(
            title = "Interaction b/w Interest Rate and Credit Score",
            x = "Interest Rate",
            y = "Credit Score"
        ) +
        theme_bw()
```

As seen from the above chart, it can be clearly seen that the customers with high credit score are immune to interest rates but as we go below credit score of 727, their loan repayment rate starts to go down across different interest rate bins. Based on this, we don't see any interaction between Credit Score and Interest Rate.

### Heatmap of Employment Status by Grade Sub-grade

Finally, let's look at heatmap to understand the interaction between Employment Status by Grade Sub-grade.

```{r es_gs_int, include = TRUE}
#| fig.width: 12
#| fig.height: 8
#| fig.align: "center"
train_bins_char %>%
    group_by(employment_status, grade_subgrade) %>%
    summarise(good_rate = mean(loan_paid_back == 1)) %>%
    ggplot(aes(x = grade_subgrade, y = employment_status, fill = good_rate)) +
    geom_tile(color = "white") +
    scale_fill_gradient(
        low = "grey90",
        high = "black",
        name = "Loan Repayment Rate"
    ) +
    labs(
            title = "Interaction b/w Employment Status by Grade Sub-grade",
            x = "Grade Sub-grade",
            y = "Employment Status"
        ) +
        theme_bw() +
        theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Save dataset
save(train_bins_char, file = "/workspace/Projects/kaggle-credit-risk-s5e11/data/processed/processedTrain.Rdata")
```

As seen from the above chart, it can be clearly seen that the dominating factor is employment status and loan repayment rate stays within a given employment status. In employment status, there seems to be minor interaction with Grade Sub-grade. But it can be ignored.

We are done with our EDA! Now, let's move to feature engineering and variable selection in next step.